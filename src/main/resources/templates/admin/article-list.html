<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <base href="/"/>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <!--[if lt IE 9]>
    <script type="text/javascript" src="lib/html5shiv.js"></script>
    <script type="text/javascript" src="lib/respond.min.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="static/h-ui/css/H-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/H-ui.admin.css"/>
    <link rel="stylesheet" type="text/css" href="lib/Hui-iconfont/1.0.8/iconfont.css"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/skin/default/skin.css" id="skin"/>
    <link rel="stylesheet" type="text/css" href="static/h-ui.admin/css/style.css"/>
    <!--[if IE 6]>
    <script type="text/javascript" src="lib/DD_belatedPNG_0.0.8a-min.js"></script>
    <script>DD_belatedPNG.fix('*');</script>
    <![endif]-->
    <title>博文列表</title>
</head>
<body>
<nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span> 博文管理 <span
        class="c-gray en">&gt;</span> 博文列表 <a class="btn btn-success radius r" style="line-height:1.6em;margin-top:3px"
                                              href="javascript:location.replace(location.href);" title="刷新"><i
        class="Hui-iconfont">&#xe68f;</i></a></nav>
<div class="page-container">
    <div class="text-c">
        <!-- <button onclick="removeIframe()" class="btn btn-primary radius">关闭选项卡</button>
         <span class="select-box inline">
         <select name="" class="select">
             <option value="0">全部分类</option>
             <option value="1">分类一</option>
             <option value="2">分类二</option>
         </select>-->
        </span> 日期范围：
        <input type="text" onfocus="WdatePicker({ maxDate:'#F{$dp.$D(\'logmax\')||\'%y-%M-%d\'}' })" id="logmin"
               class="input-text Wdate" style="width:120px;">
        -
        <input type="text" onfocus="WdatePicker({ minDate:'#F{$dp.$D(\'logmin\')}',maxDate:'%y-%M-%d' })" id="logmax"
               class="input-text Wdate" style="width:120px;">
        <input type="text" name="articleTitle" id="articleTitle" placeholder=" 博文名称" style="width:250px"
               class="input-text">
        <button class="btn btn-success" type="button" onclick="searchArticle()"><i class="Hui-iconfont">&#xe665;</i> 查询
        </button>
    </div>
    <div class="cl pd-5 bg-1 bk-gray mt-20">
        <span class="l">
            <a href="javascript:;" onclick="datadel()" class="btn btn-danger radius">
                <i class="Hui-iconfont">&#xe6e2;</i> 批量删除
            </a>
            <a class="btn btn-primary radius" data-title="添加资讯" data-href="admin/article-add.html"
               onclick="article_add('新增博文','admin/article-add.html')" href="javascript:;">
                <i class="Hui-iconfont">&#xe600;</i> 添加资讯
            </a>
        </span>
        <span class="r">共有数据：<strong id="total">0</strong> 条</span>
    </div>
    <div class="mt-20">
        <table class="table table-border table-bordered table-bg table-hover table-sort">
            <thead>
            <tr class="text-c">
                <th width="40"><input type="checkbox" name="" value=""></th>
                <th width="120">ID</th>
                <th>标题</th>
                <th width="120">更新时间</th>
                <th width="75">浏览次数</th>
                <th width="60">发布状态</th>
                <th width="120">操作</th>
            </tr>
            </thead>
            <tbody>
            <!--    <tr class="text-c">
                    <td><input type="checkbox" value="" name=""></td>
                    <td>10001</td>-->
            <!--  <td class="text-l"><u style="cursor:pointer" class="text-primary"
                                    onClick="article_edit('查看','article-zhang.html','10001')" title="查看">资讯标题</u></td>
              <td>行业动态</td>
              <td>H-ui</td>
              <td>2014-6-11 11:11:42</td>
              <td>21212</td>
              <td class="td-status"><span class="label label-success radius">已发布</span></td>
              <td class="f-14 td-manage"><a style="text-decoration:none" onClick="article_stop(this,'10001')"
                                            href="javascript:;" title="下架"><i class="Hui-iconfont">&#xe6de;</i></a> <a
                      style="text-decoration:none" class="ml-5"
                      onClick="article_edit('资讯编辑','article-add.html','10001')" href="javascript:;" title="编辑"><i
                      class="Hui-iconfont">&#xe6df;</i></a> <a style="text-decoration:none" class="ml-5"
                                                               onClick="article_del(this,'10001')" href="javascript:;"
                                                               title="删除"><i class="Hui-iconfont">&#xe6e2;</i></a>
              </td>-->
            <!-- </tr>
             <tr class="text-c">
                 <td><input type="checkbox" value="" name=""></td>
                 <td>10002</td>
                 <td class="text-l"><u style="cursor:pointer" class="text-primary"
                                       onClick="article_edit('查看','article-zhang.html','10002')" title="查看">资讯标题</u></td>
                 <td>行业动态</td>
                 <td>H-ui</td>
                 <td>2014-6-11 11:11:42</td>
                 <td>21212</td>
                 <td class="td-status"><span class="label label-success radius">草稿</span></td>
                 <td class="f-14 td-manage"><a style="text-decoration:none" onClick="article_shenhe(this,'10001')"
                                               href="javascript:;" title="审核">审核</a> <a style="text-decoration:none"
                                                                                        class="ml-5"
                                                                                        onClick="article_edit('资讯编辑','article-add.html','10001')"
                                                                                        href="javascript:;" title="编辑"><i
                         class="Hui-iconfont">&#xe6df;</i></a> <a style="text-decoration:none" class="ml-5"
                                                                  onClick="article_del(this,'10001')" href="javascript:;"
                                                                  title="删除"><i class="Hui-iconfont">&#xe6e2;</i></a>
                 </td>
             </tr>-->
            </tbody>
        </table>
    </div>
</div>
<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="static/h-ui.admin/js/H-ui.admin.js"></script>
<!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="http://127.0.0.1/lib/My97DatePicker/4.8/WdatePicker.js"></script>
<script type="text/javascript" src="lib/datatables/1.10.0/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="lib/laypage/1.2/laypage.js"></script>
<script type="text/javascript">

    $(function () {
        searchArticle();
    });

    function searchArticle() {
        var sAjaxSource = "admin/article-list?rand=" + Math.random();
        var articleTitle = $('#articleTitle').val();
        var start = $('#logmin').val().trim()==""?null:$('#logmin').val().trim();
        var end = $('#logmax').val().trim()==""?null:$('#logmax').val().trim();
        if (articleTitle != null && articleTitle != "") {
            sAjaxSource += "&articleTitle=" + articleTitle;
        }
        if( (start != null && end ==null) || (start == null && end !=null)){
            layer.msg("请输入查询的开始时间与结束时间",{icon: 2,time:1000});
            return false;
        }
        if (start != null && start != "") {
            sAjaxSource += "&start=" + start;
        }
        if (end != null && end != "") {
            sAjaxSource += "&end=" + end;
        }
        $('.table-sort').dataTable({
            "bPaginate": true,// 分页按钮
            "bStateSave": false, //是否打开客户端状态记录功能,此功能在ajax刷新纪录的时候不会将个性化设定回复为初始化状态
            "bScrollCollapse": true, //当显示的数据不足以支撑表格的默认的高度
            "bLengthChange": true, //每页显示的记录数
            "bFilter": false, //搜索栏
            "bSort": false, //是否支持排序功能
            "bInfo": true, //显示表格信息
            "bAutoWidth": true, //自适应宽度
            "bJQueryUI": false,//是否开启主题
            "bDestroy": true,
            "bProcessing": true,//开启读取服务器数据时显示正在加载中……特别是大数据量的时候，开启此功能比较好
            "bServerSide": true,////服务器处理分页，默认是false，需要服务器处理，必须true
            "sAjaxSource": sAjaxSource,//通过ajax实现分页的url路径
            "fnServerData": retrieveData,
            "aoColumns": [//初始化要显示的列
                {
                    "mDataProp": "id",//获取列数据，跟服务器返回字段一致
                    "sClass": "text-c",//显示样式
                    "mRender": function (data, type, full) {//返回自定义的样式
                        return "<input type='checkbox' class='ace' />"
                    }
                },
                {
                    "mDataProp": "id",
                    "sClass": "text-c",//显示样式
                    "bSortable": false
                },
                {
                    "mDataProp": "articleTitle",
                    "sClass": "text-c",//显示样式
                    "bSortable": false
                },
                {
                    "mDataProp": "articleUpdateDate",
                    "sClass": "text-c",//显示样式
                    "mRender": function (data, type, full) {
                        return timeStamp2String(data)
                    },
                    "bSortable": false
                }, {
                    "mDataProp": "articleViewCount",
                    "sClass": "text-c",//显示样式
                    "bSortable": false
                }, {
                    "mDataProp": "articleIsPublished",
                    "sClass": "text-c td-status",//显示样式
                    "mRender": function (data, type, full) {
                        var str = '';
                        if (data == 1) {
                            str = '<span class="label label-success radius">已发布</span>';
                        } else {
                            str = '<span class="label label-defaunt radius">未发布</span>';
                        }
                        return str;
                    },
                    "bSortable": false
                }, {
                    "mDataProp": "id",
                    "sClass": "text-c td-manage",//显示样式
                    "mRender": function (data, type, full) {
                        var str = '';
                        if (full['articleIsPublished'] == 1) {
                            str = "<a style=\"text-decoration:none\" onClick=\"article_stop(this,'"+data+"')\" href=\"javascript:;\" title=\"撤回\"><i class=\"Hui-iconfont\">&#xe6de;</i></a>" +
                                    "<a style=\"text-decoration:none\" class=\"ml-5\" onClick=\"article_edit('博文编辑','article-add.html','"+data+"')\" href=\"javascript:;\" title=\"编辑\"><i class=\"Hui-iconfont\">&#xe6df;</i></a>" +
                                    "<a style=\"text-decoration:none\" class=\"ml-5\" onClick=\"article_del(this,'"+data+"')\" href=\"javascript:;\" title=\"删除\"><i class=\"Hui-iconfont\">&#xe6e2;</i></a>";
                        } else {
                            str = "<a style=\"text-decoration:none\" onClick=\"article_start(this,'"+data+"')\" href=\"javascript:;\" title=\"发布\"><i class=\"Hui-iconfont\">&#xe603;</i></a>"
                                    + "<a style=\"text-decoration:none\" class=\"ml-5\" onClick=\"article_edit('博文编辑','article-add.html','"+data+"')\" href=\"javascript:;\" title=\"编辑\"><i class=\"Hui-iconfont\">&#xe6df;</i></a>"
                                    + "<a style=\"text-decoration:none\" class=\"ml-5\" onClick=\"article_del(this,'"+data+"')\" href=\"javascript:;\" title=\"删除\"><i class=\"Hui-iconfont\">&#xe6e2;</i></a>";
                        }
                        return str;
                    },
                    "bSortable": false
                },
            ],
            "oLanguage": {//语言设置
                "sProcessing": "处理中...",
                "sLengthMenu": "显示 _MENU_ 项结果",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            }

        });


    }
    function retrieveData(sSource, aoData, fnCallback) {

        $.ajax({
            "type": "POST",
            "contentType": "application/json",
            "url": sSource,
            "dataType": "json",
            "data": JSON.stringify(aoData),
            success: function (result) {
                var total = result['iTotalRecords'];
                $('#total').html(total);
                fnCallback(result);//把返回的数据传给这个方法就可以了,datatable会自动绑定数据的
            }
        });

    }

    /**时间戳转为日期类型***/
    function timeStamp2String(time) {
        var datetime = new Date();
        datetime.setTime(time);
        var year = datetime.getFullYear();
        var month = datetime.getMonth() + 1 < 10 ? "0" + (datetime.getMonth() + 1) : datetime.getMonth() + 1;
        var date = datetime.getDate() < 10 ? "0" + datetime.getDate() : datetime.getDate();
        var hour = datetime.getHours() < 10 ? "0" + datetime.getHours() : datetime.getHours();
        var minute = datetime.getMinutes() < 10 ? "0" + datetime.getMinutes() : datetime.getMinutes();
        var second = datetime.getSeconds() < 10 ? "0" + datetime.getSeconds() : datetime.getSeconds();
        return year + "-" + month + "-" + date + " " + hour + ":" + minute + ":" + second;
    }

    /*资讯-添加*/
    function article_add(title, url, w, h) {
        var index = layer.open({
            type: 2,
            title: title,
            content: url
        });
        layer.full(index);
    }
    /*资讯-编辑*/
    function article_edit(title, url, id, w, h) {
        var index = layer.open({
            type: 2,
            title: title,
            content: url
        });
        layer.full(index);
    }
    /*资讯-删除*/
    function article_del(obj, id) {
        layer.confirm('确认要删除吗？', function (index) {
            $.ajax({
                type: 'POST',
                url: 'admin/article/delArticle/'+id,
                dataType: 'json',
                success: function (data) {
                    $(obj).parents("tr").remove();
                    layer.msg('已删除!', {icon: 1, time: 1000});
                },
                error: function (data) {
                    layer.msg('删除失败!', {icon: 1, time: 1000});
                },
            });
        });
    }

    /*资讯-审核*/
    function article_shenhe(obj, id) {
        layer.confirm('审核文章？', {
                    btn: ['通过', '不通过', '取消'],
                    shade: false,
                    closeBtn: 0
                },
                function () {
                    $(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="article_start(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
                    $(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
                    $(obj).remove();
                    layer.msg('已发布', {icon: 6, time: 1000});
                },
                function () {
                    $(obj).parents("tr").find(".td-manage").prepend('<a class="c-primary" onClick="article_shenqing(this,id)" href="javascript:;" title="申请上线">申请上线</a>');
                    $(obj).parents("tr").find(".td-status").html('<span class="label label-danger radius">未通过</span>');
                    $(obj).remove();
                    layer.msg('未通过', {icon: 5, time: 1000});
                });
    }
    /*资讯-下架*/
    function article_stop(obj, id) {
        var url="admin/article/changeArticleStatus/0/"+id;
        layer.confirm('确认要撤回吗？', function (index) {
            $.ajax({
                type: "POST",
                url:url,
                dataType:"json",
                success:function(data){
                    if(data["status"]){

                        $(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="article_start(this,'+id+')" href="javascript:;" title="发布"><i class="Hui-iconfont">&#xe603;</i></a>');
                        $(obj).parents("tr").find(".td-status").html('<span class="label label-defaunt radius">未发布</span>');
                        $(obj).remove();
                        layer.msg('已撤回!', {icon: 5, time: 1000});
                    }else{
                        layer.msg('撤回失败!', {icon: 6, time: 1000});
                    }
                }
            });


        });
    }

    /*资讯-发布*/
    function article_start(obj, id) {
        layer.confirm('确认要发布吗？', function (index) {
            var url="admin/article/changeArticleStatus/1/"+id;
            $.ajax({
                type: "POST",
                url:url,
                dataType:"json",
                success:function(data){
                    if(data["status"]){
                        $(obj).parents("tr").find(".td-manage").prepend('<a style="text-decoration:none" onClick="article_stop(this,'+id+')" href="javascript:;" title="撤回"><i class="Hui-iconfont">&#xe6de;</i></a>');
                        $(obj).parents("tr").find(".td-status").html('<span class="label label-success radius">已发布</span>');
                        $(obj).remove();
                        layer.msg('已发布!', {icon: 6, time: 1000});
                    }else{
                        layer.msg('发布失败!', {icon: 6, time: 1000});
                    }
                }
            });

        });
    }
    /*资讯-申请上线*/
    function article_shenqing(obj, id) {
        $(obj).parents("tr").find(".td-status").html('<span class="label label-default radius">待审核</span>');
        $(obj).parents("tr").find(".td-manage").html("");
        layer.msg('已提交申请，耐心等待审核!', {icon: 1, time: 2000});
    }

</script>
</body>
</html>